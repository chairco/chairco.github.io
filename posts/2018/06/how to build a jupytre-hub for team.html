<!DOCTYPE html>
<html lang="zh-hant">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Target 目前有組一台主機來做科學計算，因此打算建構一個 remote 環境運行 Jupyterhub 跑科學計算。 原則上使用 jupyterhub 只是假設未來有多人使用需求可以區隔環境。 架構大概是這樣： 設定 透過 jupyterhub 來設定多人可登入主機。官方教學會有幾個重點： 下載與安裝 anaconda3 安裝工具 建立 Jupyterhub server 資料夾 設定 ...">
        <meta name="keywords" content="Python">
        
        <link rel="icon" href="https://chairco.github.io/myfavicon.ico">
        <link rel="shortcut icon" href="https://chairco.github.io/myfavicon.ico" type="image/x-icon" />
        <link rel="Bookmark" href="https://chairco.github.io/myfavicon.ico" type="image/x-icon" />

        <title>如何建立一個團隊用的&nbsp;Jupyter-Hub - Jason's Blog</title>

        <!-- Stylesheets -->
        <link href="https://chairco.github.io/theme/css/all.min.css" rel="stylesheet">
        <!-- /Stylesheets -->

        <!-- RSS Feeds -->
        <link href="https://chairco.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jason's Blog Full Atom Feed" />
        <link href="https://chairco.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Jason's Blog Full RSS Feed" />
        <link href="https://chairco.github.io/feeds/jupyter.atom.xml" type="application/atom+xml" rel="alternate" title="Jason's Blog Categories Atom Feed" />
        <!-- /RSS Feeds -->

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

        <!-- Google Analytics -->
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-79798833-1', 'auto');
          ga('send', 'pageview');
        </script>
        <!-- /Google Analytics -->


    </head>

    <body>

        <!-- Header -->
    <div class="header-container" style="background: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2)), url('https://chairco.github.io/images/home-bg.jpg'); background-position: center; background-size: cover;">

            <!-- Static navbar -->
            <div class="container">
                <div class="header-nav">
                    <div class="header-logo">
                        <a class="pull-left" href="https://chairco.github.io/"><img class="mr20" src="https://chairco.github.io/images/logo.png" alt="logo">Jason's Blog</a>
                    </div>
                    <div class="nav pull-right">
                                <a href="https://chairco.github.io/pages/about-me/">About</a>
                                <a href="https://chairco.github.io/cv">Resume</a>
                                <a href="https://chairco.github.io/categories.html">Categories</a>
                    </div>
                </div>
            </div>
            <!-- /Static navbar -->

            <!-- Header -->
    <!-- Header -->
    <div class="container header-wrapper">
        <div class="row">
              <div class="col-lg-12">
                  <div class="header-content">
                      <h1 class="header-title">如何建立一個團隊用的&nbsp;Jupyter-Hub</h1>
                      <p class="header-date">By <a href="https://chairco.github.io/author/jason.html">Jason</a>, Jun 19, 2018, modified Jun 20, 2018, in category <a href="https://chairco.github.io/category/jupyter.html">Jupyter</a></p>
                      <div class="header-underline"></div>
                      <div class="clearfix"></div>
                      <p class="pull-right header-tags">
                          <span class="glyphicon glyphicon-tags mr5" aria-hidden="true"></span>
<a href="https://chairco.github.io/tag/python.html">Python</a>                      </p>
                  </div>
              </div>
        </div>
    </div>
    <!-- /Header -->
            <!-- /Header -->

        </div>
        <!-- /Header -->


        <!-- Content -->
    <div class="container content">
        <h2>Target</h2>
<p>目前有組一台主機來做科學計算，因此打算建構一個 remote 環境運行 Jupyterhub 跑科學計算。
原則上使用 jupyterhub&nbsp;只是假設未來有多人使用需求可以區隔環境。</p>
<p>架構大概是這樣：</p>
<p><img alt="#" src="http://jupyterhub.readthedocs.io/en/latest/_images/jhub-parts.png" /></p>
<h2>設定</h2>
<p>透過 jupyterhub 來設定多人可登入主機。<a href="https://github.com/jupyterhub/jupyterhub/wiki/Installation-of-Jupyterhub-on-remote-server">官方教學</a>會有幾個重點：</p>
<ul>
<li>下載與安裝&nbsp;anaconda3</li>
<li>安裝工具</li>
<li>建立 Jupyterhub server&nbsp;資料夾</li>
<li>設定 https 建立一組認證&nbsp;key</li>
<li>認證方式（<span class="caps">PAM</span>）</li>
</ul>
<h3>下載與安裝&nbsp;anaconda3</h3>
<div class="codehilite"><pre><span></span><span class="c1"># wget anaconda and install</span>
$ wget https://repo.continuum.io/archive/Anaconda3-5.1.0-Linux-x86_64.sh
$ bash Anaconda2-4.0.0-Linux-x86_64.sh
</pre></div>


<h3>安裝工具</h3>
<p>安裝 node.js 與套件管理工具&nbsp;npm</p>
<div class="codehilite"><pre><span></span>$ sudo apt-get install npm nodejs-legacy
</pre></div>


<p>接著安裝&nbsp;proxy </p>
<div class="codehilite"><pre><span></span>$ npm install -g configurable-http-proxy
</pre></div>


<p>因為一開始就用 anaconda 安裝 Python，anaconda 管理套件方式是採用 <code>conda</code> 因此直接用 <code>conda</code> 安裝 jupyterhub 和 notebook (<a href="https://jupyterhub.readthedocs.io/en/latest/quickstart.html">參考</a>)</p>
<div class="codehilite"><pre><span></span>$ conda install -c conda-forge jupyterhub
$ conda install notebook
</pre></div>


<p>安裝完成之後測試看看是否 hub 和 proxy 都有安裝成功，執行下面兩個指令如果有跑處 help&nbsp;畫面就算是成功</p>
<div class="codehilite"><pre><span></span>$ jupyterhub -h
$ configurable-http-proxy -h
</pre></div>


<h3>建立 Jupyterhub server&nbsp;資料夾</h3>
<p>建議在 <code>/etc/</code> 底下，建立一個 jupyterhub&nbsp;資料夾</p>
<div class="codehilite"><pre><span></span>sudo mkdir -p /etc/jupyterhub
</pre></div>


<p>測試在這個資料夾底下執行 jupyterhub，但因為這是沒有 ssl 所以是採&nbsp;http，http://your_ip_address:8000</p>
<div class="codehilite"><pre><span></span>$ jupyterhub --no-ssl
</pre></div>


<h3>設定 https 建立認證&nbsp;key</h3>
<p>在路徑 <code>/etc/jupyterhub</code> 底下產生</p>
<div class="codehilite"><pre><span></span>openssl req -x509 -nodes -days <span class="m">365</span> -newkey rsa:1024 -keyout mykey.key -out mycert.pem
</pre></div>


<p>產生 ssl 認證 key 之後接著就可以用 https 登入&nbsp;hub</p>
<div class="codehilite"><pre><span></span>$ jupyterhub
</pre></div>


<p>接著可以建立 hub 的 config&nbsp;file</p>
<div class="codehilite"><pre><span></span><span class="c1">#Create Jupyterhub configuration file</span>
$ jupyterhub --generate-config
</pre></div>


<p>接著下面會說明認證方式，接著再回來說明 config file: jupyterhub_config.py&nbsp;如何設定</p>
<h3>認證方式（<span class="caps">PAM</span>）</h3>
<p>比較複雜，使用 <span class="caps">PAM</span> 所以會綁定系統的帳戶。<a href="https://github.com/jupyterhub/jupyterhub/wiki/Using-sudo-to-run-JupyterHub-without-root-privileges">參考</a></p>
<p>流程大略是安裝一個 <code>sudospwawner</code> 接著建立一個帳號來做啟動 jupyterhub 這樣就可以不需要 root&nbsp;權限並做認證。</p>
<div class="codehilite"><pre><span></span><span class="c1"># create user run hub</span>
$ sudo useradd rhea

<span class="c1"># Spawner to enable monitoring the single-user servers with sudo:</span>
$ sudo pip install sudospawner
</pre></div>


<p>編輯  <code>/etc/sudoers</code> 或是 (use <code>visudo</code> for safe editing of&nbsp;sudoers):</p>
<ul>
<li>specify the list of users for whom rhea can spawn servers&nbsp;(JUPYTER_USERS)</li>
<li>specify the command that rhea can execute on behalf of users&nbsp;(JUPYTER_CMD)</li>
<li>give rhea permission to run JUPYTER_CMD on behalf of JUPYTER_USERS without entering a&nbsp;password</li>
</ul>
<div class="codehilite"><pre><span></span># comma-separated whitelist of users that can spawn single-user servers
# this should include all of your Hub users
Runas_Alias JUPYTER_USERS = rhea, zoe, wash

# the command(s) the Hub can run on behalf of the above users without needing a password
# the exact path may differ, depending on how sudospawner was installed
Cmnd_Alias JUPYTER_CMD = /usr/local/bin/sudospawner

# actually give the Hub user permission to run the above command on behalf
# of the above users without prompting for a password
rhea ALL=(JUPYTER_USERS) NOPASSWD:JUPYTER_CMD
</pre></div>


<p>接著啟用 <span class="caps">PAW</span> 不須要 root&nbsp;權限，首先先確認權限狀態</p>
<div class="codehilite"><pre><span></span>$ ls -l /etc/shadow
-rw-r-----  <span class="m">1</span> root shadow   <span class="m">2197</span> Jul <span class="m">21</span> 13:41 shadow
$ ls -l /etc/shadow
-rw-------  <span class="m">1</span> root wheel   <span class="m">2197</span> Jul <span class="m">21</span> 13:41 shadow
</pre></div>


<p>接著建立 <code>shadow</code> 群組並且修改檔案權限</p>
<div class="codehilite"><pre><span></span>$ sudo groupadd shadow
$ sudo chgrp shadow /etc/shadow
$ sudo chmod g+r /etc/shadow
</pre></div>


<p>將 <code>rhea</code> 增加為 <code>shadow</code> 群組</p>
<div class="codehilite"><pre><span></span>$ sudo usermod -a -G shadow rhea
</pre></div>


<p>設定 port 80 可以運行 jupyterhub，如果有錯誤可以查看這篇<a href="https://gist.github.com/chairco/99342c9e5d7fba51e1b8f69a7b5ccf11">參考</a></p>
<div class="codehilite"><pre><span></span>$ sudo setcap <span class="s1">&#39;cap_net_bind_service=+ep&#39;</span> /usr/bin/node
or 
$ sudo setcap <span class="s1">&#39;cap_net_bind_service=+ep&#39;</span> <span class="sb">`</span>which node<span class="sb">`</span>
</pre></div>


<p>最後要設定 jupyterhub_config.py。也可以參考<a href="https://jupyterhub.readthedocs.io/en/0.7.0/config-examples.html">官網</a></p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>

<span class="c1"># db</span>
<span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">db_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;jupyterhub.sqlite&#39;</span><span class="p">)</span>


<span class="c1"># Jupyterhub setting</span>

<span class="n">c</span><span class="o">.</span><span class="n">Spawner</span><span class="o">.</span><span class="n">default_url</span> <span class="o">=</span> <span class="s1">&#39;/lab&#39;</span> <span class="c1"># should be install jupyter labextension</span>
<span class="n">c</span><span class="o">.</span><span class="n">Spawner</span><span class="o">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;jupyter-labhub&#39;</span><span class="p">]</span>
<span class="n">c</span><span class="o">.</span><span class="n">Spawner</span><span class="o">.</span><span class="n">notebook_dir</span> <span class="o">=</span> <span class="s1">&#39;~/notebooks&#39;</span>


<span class="c1">## Jupyterhub service setting by Jason</span>

<span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">spawner_class</span> <span class="o">=</span> <span class="s1">&#39;sudospawner.SudoSpawner&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">ssl_cert</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;mycert.pem&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">ssl_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;mykey.key&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">cookie_secret_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;jupyterhub_cookie_secret&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">proxy_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/usr/local/bin/configurable-http-proxy&#39;</span><span class="p">]</span>


<span class="c1"># This is an application.</span>
<span class="c1"># create system users that don&#39;t exist yet</span>
<span class="n">c</span><span class="o">.</span><span class="n">LocalAuthenticator</span><span class="o">.</span><span class="n">create_system_users</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">c</span><span class="o">.</span><span class="n">Authenticator</span><span class="o">.</span><span class="n">whitelist</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;{username}&#39;</span><span class="p">}</span>
<span class="n">c</span><span class="o">.</span><span class="n">Authenticator</span><span class="o">.</span><span class="n">admin_users</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;{username}&#39;</span><span class="p">}</span>
</pre></div>


<h2>安裝必要套件</h2>
<ul>
<li><a href="https://github.com/jupyterhub/jupyterlab-hub">jupyterlab</a> </li>
<li><a href="https://github.com/bokeh/jupyterlab_bokeh">jupyter bokeh</a>, <a href="https://github.com/bokeh/bokeh/issues/6700">issue</a></li>
<li>R&nbsp;kernal</li>
</ul>
<h3>Jupyterlab</h3>
<p>用來讓畫面比較好看</p>
<div class="codehilite"><pre><span></span>$ jupyter labextension install @jupyterlab/hub-extension
</pre></div>


<h3>Jupyter&nbsp;bokeh</h3>
<p>畫圖用，裝了 jupyterlab&nbsp;一定要裝這個套件才能正常運作</p>
<div class="codehilite"><pre><span></span>$ jupyter labextension install jupyterlab_bokeh
</pre></div>


<h3>R&nbsp;kernal</h3>
<p>可以選擇 R&nbsp;來運作</p>
<div class="codehilite"><pre><span></span>$ conda update anaconda
$ conda install -c r r-essentials
</pre></div>


<h2>帳號設定</h2>
<p>如果要使用 jupyterhub 來進行帳號認證流程如下：
+ 透過 sudo 建立一個帳號
+ 帳號設定為 jupyterhub 群組
+ 新增的帳號家目錄底下新建一個 /notebooks 的資聊夾用來存放分析程式
+ 編輯 /etc/sudoer&nbsp;將使用者加入 </p>
<p>操作流程</p>
<div class="codehilite"><pre><span></span><span class="c1"># 新增帳號, useradd (不會建立家目錄) adduser (會建立家目錄)</span>
$ sudo adduser jupyter

<span class="c1"># 將帳號設定為 jupyterhub 群組</span>
$ sudo usermod -a -G jupyterhub jupyter

<span class="c1"># 新帳號底下建立 notebooks 資料夾</span>
$ sudo su jupyter
$ mkdir -p ~/.notebooks

<span class="c1"># 編輯 /etc/sudoer 將使用sudo vim /etc/sudoers者加入可以登入權限</span>
$ sudo vim /etc/sudoers
Runas_Alias <span class="nv">JUPYTER_USERS</span> <span class="o">=</span> jupyter
</pre></div>


<h2>啟動&nbsp;server</h2>
<div class="codehilite"><pre><span></span>sudo -u rhea jupyterhub -f /etc/jupyterhub/jupyterhub_config.py  
</pre></div>


<p>使用帳號登入 localhost:8000 並且啟動&nbsp;server</p>
<hr />
<p>參考文獻</p>
<ul>
<li><a href="https://medium.com/@ybarraud/setting-up-jupyterhub-with-sudospawner-and-anaconda-844628c0dbee">jupyterhub root&nbsp;設定</a></li>
<li><a href="http://hsusir.org/jupyter-r-python/">安裝 jupyter&nbsp;R</a></li>
<li><a href="https://github.com/jupyterhub/jupyterhub/wiki/Installation-of-Jupyterhub-on-remote-server">Jupyter remote&nbsp;server</a></li>
</ul>


    <div class="comments">
        <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'chairco';
                var disqus_identifier = 'posts/2018/06/how to build a jupytre-hub for team.html';
                var disqus_url = 'https://chairco.github.io/posts/2018/06/how to build a jupytre-hub for team.html';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
        <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>
        
    </div>
        <!-- /Content --> 

        <!-- Footer -->
        <div class="footer gradient-2">
            <div class="container footer-container ">
                <div class="row">
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Sitemap</div>
                        <ul class="list-unstyled">
                            <li><a href="https://chairco.github.io/archives.html">Archives</a></li>
                            <li><a href="https://chairco.github.io/tags.html">Tags</a></li>
                            <li><a href="https://chairco.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">Atom Feed</a></li>
                            <li><a href="https://chairco.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate">RSS Feed</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Social</div>
                        <ul class="list-unstyled">
                            <li><a href="https://github.com/chairco" target="_blank">Github</a></li>
                            <li><a href="https://twitter.com/ChaircoChen" target="_blank">Twitter</a></li>
                            <li><a href="mailto:chairco@gmail.com" target="_blank">Email</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                    </div> 
                    <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
                        <p class="pull-right text-right">
                            <small><em>Proudly powered by <a href="http://docs.getpelican.com/" target="_blank">pelican</a></em></small><br/>
                            <small><em>Theme and code by <a href="https://github.com/molivier" target="_blank">molivier</a></em></small><br/>
                            <small>&copy; Jason's Blog 2018</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Footer -->
    </body>
</html>