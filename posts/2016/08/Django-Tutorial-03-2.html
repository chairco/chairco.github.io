<!DOCTYPE html>
<html lang="zh-hant">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="../../../theme/stylesheet/style.css">

  <link rel="stylesheet" type="text/css" href="../../../theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="../../../theme/font-awesome/css/font-awesome.min.css">





  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />


<meta name="author" content="chairco" />
<meta name="description" content="接下來我們為系統加點功能，想想一個借用系統如果沒有權限控管就不容易追蹤使用系統的人和流程。所以我想為這個系統加上權限控管。 很棒的是 Django 本身就有權限管理功能，只要在 borrow/urls.py 加上 url(r'^accounts/', include('django.contrib.auth.urls')), 這個路徑就可以啟用登入的功能。所以現在 borrow/borrow/urls ..." />
<meta name="keywords" content="Coding, Django">
<meta property="og:site_name" content="chairco's blog"/>
<meta property="og:title" content="Django 教學第三篇-用 CBV 來做程式開發(續)"/>
<meta property="og:description" content="接下來我們為系統加點功能，想想一個借用系統如果沒有權限控管就不容易追蹤使用系統的人和流程。所以我想為這個系統加上權限控管。 很棒的是 Django 本身就有權限管理功能，只要在 borrow/urls.py 加上 url(r'^accounts/', include('django.contrib.auth.urls')), 這個路徑就可以啟用登入的功能。所以現在 borrow/borrow/urls ..."/>
<meta property="og:locale" content="zh_TW"/>
<meta property="og:url" content="../../../posts/2016/08/Django-Tutorial-03-2.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2016-08-12 09:48:38+08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="../../../author/chairco.html">
<meta property="article:section" content="Coding"/>
<meta property="article:tag" content="Coding"/>
<meta property="article:tag" content="Django"/>
<meta property="og:image" content="/pics/20161206.png">
  <title>chairco's blog &ndash; Django 教學第三篇-用 CBV 來做程式開發(續)</title>
</head>
<body>
  <aside>
    <div>
      <a href="../../..">
        <img src="/pics/20161206.png" alt="Jason's Blog" title="Jason's Blog">
      </a>
      <h1><a href="../../..">Jason's Blog</a></h1>
<p>Code / Travel / Other</p>      <nav>
        <ul class="list">
          <li><a href="../../../pages/about-me/#about-me">About&nbsp;Me</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-google" href="#" target="_blank"><i class="fa fa-google"></i></a></li>
        <li><a class="sc-twitter" href="#" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-facebook" href="https://www.facebook.com/chairco" target="_blank"><i class="fa fa-facebook"></i></a></li>
        <li><a class="sc-github" href="https://github.com/chairco" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-envelope-o" href="mailto:chairco@gmail.com" target="_blank"><i class="fa fa-envelope-o"></i></a></li>
        <li><a class="sc-linkedin" href="#" target="_blank"><i class="fa fa-linkedin"></i></a></li>
      </ul>
    </div>
    <div>
      <iframe src="https://www.facebook.com/plugins/follow.php?href=https%3A%2F%2Fwww.facebook.com%2Fchairco&width=76&height=21&layout=button_count&size=small&show_faces=true&appId=242673589413437" width="76" height="21" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowTransparency="true"></iframe>
    </div>
  </aside>
  <main>
    <nav>
      <a href="../../..">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
    </nav>

<article>
  <header>
    <h1 id="Django-Tutorial-03-2">Django 教學第三篇-用 <span class="caps">CBV</span>&nbsp;來做程式開發(續)</h1>
    <p>Posted on  8 12, 2016 in <a href="../../../category/coding.html">Coding</a></p>
  </header>
  <div>
    <p>接下來我們為系統加點功能，想想一個借用系統如果沒有權限控管就不容易追蹤使用系統的人和流程。所以我想為這個系統加上權限控管。</p>
<p>很棒的是 Django 本身就有權限管理功能，只要在 <code>borrow/urls.py</code> 加上 <code>url(r'^accounts/', include('django.contrib.auth.urls')),</code> 這個路徑就可以啟用登入的功能。所以現在 <code>borrow/borrow/urls.py</code> 這個檔案會長這樣：</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>

<span class="kn">from</span> <span class="nn">pages.views</span> <span class="kn">import</span> <span class="n">index</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="s1">r&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s1">r&#39;^$&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;home&#39;</span><span class="p">),</span>

    <span class="n">url</span><span class="p">(</span><span class="s1">r&#39;^loan/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;loans.urls&#39;</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s1">r&#39;^faship/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;faships.urls&#39;</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s1">r&#39;^accounts/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;django.contrib.auth.urls&#39;</span><span class="p">)),</span>
<span class="p">]</span>
</pre></div>


<p>有了登入的 router 後接著要建立一個 login 的 template，所以在 <code>borrow/templates/</code> 先建立一個資料夾 <code>registration</code> 接著再到資料夾內建立一個 <code>login.html</code>。</p>
<p><code>loging.html</code> 就是 <code>url(r'^accounts/', include('django.contrib.auth.urls'))</code> 的&nbsp;template，打入這個路徑後就會顯示編輯頁面，內容像是這樣：</p>
<div class="codehilite"><pre><span></span>{% extends &#39;base.html&#39; %}
{% load crispy_forms_tags %}

{% block body %}
{{ block.super }}
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;row&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-lg-4 col-md-6 col-lg-offset-4 col-md-offset-3&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h2</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-signin-heading&quot;</span><span class="p">&gt;</span>Please Sign In<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
      {% csrf_token %}
      {{ form|crispy }}
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary&quot;</span><span class="p">&gt;</span>登入<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
{% endblock body %}
</pre></div>


<p>一樣是繼承 base.html 然後用 crispy_forms_tags 來修飾我們的 form。比較特別是建立了一個 submit 的 button 來觸發行為。接著你可以試試看鍵入 <a href="http://127.0.0.1:8000/accounts/login/">http://127.0.0.1:8000/accounts/login/</a>&nbsp;就會顯示出類似下面的登入畫面</p>
<p><img alt="django-tutorial-ch3-2-p1" src="/pics/201608/django-tutorial-ch3-2-p1.png" /></p>
<p>有看到上面圖片右上角的登入畫面嗎？總是要有一個接入的端口，這時就需要在 <code>base.html</code> 裡的 <code>&lt;nav&gt;</code> 標籤裡再增加 <code>&lt;div&gt;</code> 的標籤。所以我們打開 <code>borrow/templates/base/base.html</code> 加一些東西，就會顯示登入的按鈕，試試看能不能用你在 admin&nbsp;增加的帳號登入吧。</p>
<div class="codehilite"><pre><span></span>...
<span class="p">&lt;</span><span class="nt">nav</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">form</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-right navbar-form&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;{% url &#39;logout&#39; %}&quot;</span><span class="p">&gt;</span>
            {% if user.is_authenticated %}
            {% csrf_token %}
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;next&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;{% url &#39;home&#39; %}&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-default&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="p">&gt;</span>{{ user }} 登出<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
            {% else %}
            <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-default&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{% url &#39;login&#39; %}&quot;</span><span class="p">&gt;</span>登入<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
            {% endif %}
        <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">nav</span><span class="p">&gt;</span>
</pre></div>


<p>不過到這邊還不夠，應該還要限制某些頁面需要登入後才能瀏覽對吧？通常用 <span class="caps">FBV</span> 來開發會很習慣在 views.py 內針對需要管理的頁面透過 decorator&nbsp;來處理，例如：</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>

<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;hello_world.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;current_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()})</span>
</pre></div>


<p>不過因為用 <span class="caps">CBV</span> 來開發，這個方法可能就不適用。不過令人開心的是 login_required 這個 decorator 是可以透過將 <span class="caps">CBV</span> 的 as_view()&nbsp;函式當作參數，一樣就可以實做這個功能。</p>
<p>那來實作一下吧，以這個範例需要登入才能動作應該是新增一個需求，所以到 <code>borrow/faships/urls.py</code> 找到新增的 router，將 login_required 當作一個函數，將 <code>views.FashipCreateView.as_view()</code> 傳遞進去。</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span><span class="p">,</span> <span class="n">permission_required</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">...</span>
    <span class="n">url</span><span class="p">(</span><span class="s1">r&#39;^add/$&#39;</span><span class="p">,</span> <span class="n">login_required</span><span class="p">(</span><span class="n">views</span><span class="o">.</span><span class="n">FashipCreateView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;faship_add&#39;</span><span class="p">),</span>
    <span class="o">...</span>
<span class="p">]</span>
</pre></div>


<p>試試看先把帳號登出，然後點選新增功能時 Django 是不是會自動幫你導到登入畫面呢？很棒吧，所有功能幾乎都幫我們開發好了，今天實做的功能幾乎都是在寫&nbsp;html。</p>
<hr />
<p>花了一點時間寫了這份教學，其實到這邊所學的 Django 也是進階再進階了，接下來其實就是閱讀更多的官方文件，加強 <span class="caps">JS</span> 和 <span class="caps">CSS</span> 照理說沒有做不出來的功能，當然這裡沒有教大家如何 deploy 到雲端平台，關於這個問題我想還是留給大家自我學習吧， Django girl 的官方網站是用&nbsp;pythonanywhere，當然不僅僅只有這個，還有一樣棒的雲端平台，至於如何選擇就取決於你對於平台掌握度。</p>
<p>那這個主題就到這個段落，很歡迎大家提出問題一起討論，但我想這個只是我心裡的期待，不過還是希望當你讀過之後能幫助到你，不管是出於工作、興趣或是單純打發時間。</p>
<p>接著我將會寫些 python 的其他主題，也許會關於一些機器學習的部分(<span class="caps">ML</span>)。下回見吧。</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="../../../tag/coding.html">Coding</a>
      <a href="../../../tag/django.html">Django</a>
    </p>
  </div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'chairco';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</article>

    <footer>
<p>
  &copy; chairco 2016 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-79798833-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->



<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " chairco's blog ",
  "url" : "../../..",
  "image": "/pics/20161206.png",
  "description": "Jason's Blog"
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Django 教學第三篇-用 CBV 來做程式開發(續)",
  "headline": "Django 教學第三篇-用 CBV 來做程式開發(續)",
  "datePublished": "2016-08-12 09:48:38+08:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "chairco",
    "url": "../../../author/chairco.html"
  },
  "image": "/pics/20161206.png",
  "url": "../../../posts/2016/08/Django-Tutorial-03-2.html",
  "description": "接下來我們為系統加點功能，想想一個借用系統如果沒有權限控管就不容易追蹤使用系統的人和流程。所以我想為這個系統加上權限控管。 很棒的是 Django 本身就有權限管理功能，只要在 borrow/urls.py 加上 url(r'^accounts/', include('django.contrib.auth.urls')), 這個路徑就可以啟用登入的功能。所以現在 borrow/borrow/urls ..."
}
</script></body>
</html>